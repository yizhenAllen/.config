"use strict";var $=Object.defineProperty;var O=Object.getOwnPropertyDescriptor;var Q=Object.getOwnPropertyNames;var X=Object.prototype.hasOwnProperty;var j=(i,t)=>{for(var o in t)$(i,o,{get:t[o],enumerable:!0})},H=(i,t,o,p)=>{if(t&&typeof t=="object"||typeof t=="function")for(let l of Q(t))!X.call(i,l)&&l!==o&&$(i,l,{get:()=>t[l],enumerable:!(p=O(t,l))||p.enumerable});return i};var J=i=>H($({},"__esModule",{value:!0}),i);var ae={};j(ae,{default:()=>L});module.exports=J(ae);var s=require("@raycast/api"),E=require("child_process"),m=require("react");var ee=["B","kB","MB","GB","TB","PB","EB","ZB","YB"],te=["B","KiB","MiB","GiB","TiB","PiB","EiB","ZiB","YiB"],ie=["b","kbit","Mbit","Gbit","Tbit","Pbit","Ebit","Zbit","Ybit"],se=["b","kibit","Mibit","Gibit","Tibit","Pibit","Eibit","Zibit","Yibit"],F=(i,t,o)=>{let p=i;return typeof t=="string"||Array.isArray(t)?p=i.toLocaleString(t,o):(t===!0||o!==void 0)&&(p=i.toLocaleString(void 0,o)),p};function A(i,t){if(!Number.isFinite(i))throw new TypeError(`Expected a finite number, got ${typeof i}: ${i}`);t={bits:!1,binary:!1,space:!0,...t};let o=t.bits?t.binary?se:ie:t.binary?te:ee,p=t.space?" ":"";if(t.signed&&i===0)return` 0${p}${o[0]}`;let l=i<0,y=l?"-":t.signed?"+":"";l&&(i=-i);let d;if(t.minimumFractionDigits!==void 0&&(d={minimumFractionDigits:t.minimumFractionDigits}),t.maximumFractionDigits!==void 0&&(d={maximumFractionDigits:t.maximumFractionDigits,...d}),i<1){let x=F(i,t.locale,d);return y+x+p+o[0]}let I=Math.min(Math.floor(t.binary?Math.log(i)/Math.log(1024):Math.log10(i)/3),o.length-1);i/=(t.binary?1024:1e3)**I,d||(i=i.toPrecision(3));let T=F(Number(i),t.locale,d),M=o[I];return y+T+p+M}var S=require("react"),re=()=>{};function ne(i,t){let o=(0,S.useRef)(re);(0,S.useEffect)(()=>{o.current=i},[i]),(0,S.useEffect)(()=>{if(o.current(),(t??0)>0){let l=Math.max(t??0,1e3),y=setInterval(()=>o.current(),l);return()=>clearInterval(y)}},[t])}var k=ne;var f=require("react/jsx-runtime");function L(){let[i,t]=(0,m.useState)([]),[o,p]=(0,m.useState)([]),[l,y]=(0,m.useState)(""),d=(0,s.getPreferenceValues)(),I=d.shouldSearchInPaths,T=d.shouldSearchInPid,M=d.shouldPrioritizeAppsWhenFiltering,x=d.shouldShowPID,D=d.shouldShowPath,v=+d.refreshDuration,K=d.closeWindowAfterKill,R=d.clearSearchBarAfterKill,[P,U]=(0,m.useState)(d.sortByMem),[N,W]=(0,m.useState)(d.aggregateApps),C=()=>{(0,E.exec)("ps -eo pid,ppid,pcpu,rss,comm",(e,a)=>{if(e!=null)return;let c=a.split(`
`).map(g=>{let b=["","","","","",""],B=/(\d+)\s+(\d+)\s+(\d+[.|,]\d+)\s+(\d+)\s+(.*)/,[,r,u,n,h,w]=g.match(B)??b,z=w.match(/[^/]*[^/]*$/i)?.[0]??"",V=w.includes(".prefPane"),q=w.includes(".app/");return{id:parseInt(r),pid:parseInt(u),cpu:parseFloat(n),mem:parseInt(h),type:V?"prefPane":q?"app":"binary",path:w,processName:z}}).filter(g=>g.processName!=="");t(c)})};k(C,v),(0,m.useEffect)(()=>{let e=i;N&&(e=_(e)),e.sort((a,c)=>P?a.mem>c.mem?-1:1:a.cpu>c.cpu?-1:1),p(e)},[i,P,N]);let Y=e=>e.type==="prefPane"?{fileIcon:e.path?.replace(/(.+\.prefPane)(.+)/,"$1")??""}:e.type==="app"||e.type==="aggregatedApp"?{fileIcon:e.path?.replace(/(.+\.app)(.+)/,"$1")??""}:"/System/Library/CoreServices/CoreTypes.bundle/Contents/Resources/ExecutableBinaryIcon.icns",G=e=>{(0,E.exec)(`kill -9 ${e.id}`),t(o.filter(a=>a.id!==e.id)),K&&(0,s.closeMainWindow)(),R&&(0,s.clearSearchBar)({forceScrollToTop:!0}),(0,s.showToast)({title:`\u2705 Killed ${e.processName==="-"?`process ${e.id}`:e.processName}`,style:s.Toast.Style.Success})},Z=e=>{let a=[];return e.type==="aggregatedApp"&&e.appName!=null&&a.push(e.appName),x&&a.push(e.id.toString()),D&&a.push(e.path),a.join(" - ")},_=e=>{let a=Array(),c=new Map;c.set(1,{process:{id:1},childNodes:[]});let g=Array();e.forEach(r=>{if(r.type==="app"){g.push(r.id);let u=c.get(r.id);u==null?(u={process:r,childNodes:[]},c.set(r.id,u)):u.process=r;let n=c.get(r.pid);if(n==null)n={process:void 0,childNodes:[u]},c.set(r.pid,n);else if(n.process==null)n.childNodes.push(u);else{let h;for(;n?.process!=null&&n.process.pid!==1&&(h=c.get(n.process.pid))!=null;)n=h;n?.childNodes.push(u)}n.process?.id!==1&&(n.childNodes=n.childNodes.concat(u.childNodes),u.childNodes=[])}else a.push(r)});let b=c.get(1)?.childNodes,B=Array();return b?.forEach(r=>{if(r.process==null)return;B.push(r.process.id);let u=r.childNodes.map(n=>n.process?.id).filter(n=>n!=null);B=B.concat(u),a.push({id:r.process.id,pid:r.process.pid,cpu:(r.childNodes?.reduce((n,h)=>n+(h.process?.cpu??0),0)??0)+r.process.cpu,mem:(r.childNodes?.reduce((n,h)=>n+(h.process?.mem??0),0)??0)+r.process.mem,type:"aggregatedApp",path:r.process.path,processName:r.process.processName,appName:r.process.path.match(/(?<=\/)[^/]+(?=\.app\/)/)?.[0]})}),a};return(0,f.jsx)(s.List,{isLoading:o.length===0,searchBarPlaceholder:"Filter by name...",onSearchTextChange:e=>y(e),children:o.filter(e=>{if(l==="")return!0;let a=e.processName.toLowerCase().includes(l.toLowerCase()),c=I&&e.path.toLowerCase().match(new RegExp(`.+${l}.*\\.[app|framework|prefpane]`,"ig"))!=null,g=T&&e.id.toString().includes(l),b=e.type==="aggregatedApp"&&e.appName?.toLowerCase().includes(l.toLowerCase());return a||c||g||b}).sort((e,a)=>{if(M){let c=["app","aggregatedApp"];if(c.includes(e.type)&&!c.includes(a.type))return-1;if(!c.includes(e.type)&&c.includes(a.type))return 1}return 0}).map((e,a)=>{let c=Y(e);return(0,f.jsx)(s.List.Item,{title:e.processName,subtitle:Z(e),icon:c,accessories:[{text:P?`${e.cpu.toFixed(2)}% ${A(e.mem*1024)}`:`${A(e.mem*1024)} ${e.cpu.toFixed(2)}%`}],actions:(0,f.jsxs)(s.ActionPanel,{children:[(0,f.jsx)(s.Action,{title:"Kill",icon:s.Icon.XMarkCircle,onAction:()=>G(e)}),e.path==null?null:(0,f.jsx)(s.Action.CopyToClipboard,{title:"Copy Path",content:e.path}),(0,f.jsx)(s.Action,{title:"Reload",icon:s.Icon.ArrowClockwise,shortcut:{key:"r",modifiers:["cmd"]},onAction:()=>C()}),(0,f.jsx)(s.Action,{title:`Sort by ${P?"CPU":"memory"} usage`,icon:s.Icon.Filter,shortcut:{key:"tab",modifiers:[]},onAction:()=>{U(!P),(0,s.showToast)({title:`Sorted by ${P?"CPU":"memory"} usage`})}}),(0,f.jsx)(s.Action,{title:`${N?"Dis":"En"}able aggregating apps`,icon:s.Icon.AppWindow,shortcut:{key:"tab",modifiers:["shift"]},onAction:()=>{W(!N),(0,s.showToast)({title:`${N?"Dis":"En"}abled aggregating apps`})}})]})},a)})})}
